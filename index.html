<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script type="text/javascript" src="chloroplethtime.js"></script>
    <style>

    </style>
</head>

<body>
    <div id="vis1"></div>
    <br>
    <input type="range" id='slider' min="0" max="200" step="1"></input>
    <br>

    <p>
      <svg id="jkm253" height="800" width="900" style="margin: 20px" /></svg>
      <h4>Median Income by State</h4>
    </p>

    <script>
        chgraphtime();
        async function getAverageByState() {
            let countyIncome = d3.csv('kaggle_income.csv', d3.autoType).then(countyIncome => {
              let states = new Set(d3.map(countyIncome, d => d['State_ab']));
              let statesIncome = [];

              countyIncome.forEach((d, i) => {
                  d.Median = Number(d.Median)
              });
              states.forEach(d => {
                  let sum = 0;
                  let i = d3.filter(countyIncome, c => {
                      return c['State_ab'] === d;
                  });
                  i.forEach(c => {
                      sum = sum + c['Median'];
                  })
                  //  console.log(sum)
                  statesIncome.push({ state: d, income: sum / i.length });
              });
              console.log(statesIncome);
              return statesIncome;
            });
        }

        // Jade's graph

      let getData = async function() {
        let countyIncome = d3.csv('kaggle_income.csv', d3.autoType).then(countyIncome => {
          let states = new Set(d3.map(countyIncome, d => d['State_ab']));
          let statesIncome = [];

          countyIncome.forEach((d, i) => {
              d.Median = Number(d.Median)
          });
          states.forEach(d => {
              let sum = 0;
              let i = d3.filter(countyIncome, c => {
                  return c['State_ab'] === d;
              });
              i.forEach(c => {
                  sum = sum + c['Median'];
              })
              //  console.log(sum)
              statesIncome.push({ state: d, income: sum / i.length });
          });

          console.log(statesIncome);

          let state_data = d3.json('us_states.json', d3.autoType).then(state_data => {

            let state_income = statesIncome;

            let svg = d3.select("svg#jkm253");
            let svgWidth = svg.attr("width");
            let svgHeight = svg.attr("height");

            let states = topojson.feature(state_data, state_data.objects.states);
            let statesMesh = topojson.mesh(state_data, state_data.objects.states);
            let usMesh = topojson.mesh(state_data, state_data.objects.nation);

            let projection = d3.geoAlbersUsa().fitSize([svgWidth, svgHeight], states);
            var path = d3.geoPath().projection(projection);

            let colorArray = ["#0d06aa","#0055d5","#1eabd0","#00d4a1","#6aff45"];

            for (var i = 0; i < state_income.length; i++) {

      // Grab State Name
      var state = state_income[i].state;

      // Grab data value
      var income = state_income[i].income;

      // Find the corresponding state inside the GeoJSON
      for (var j = 0; j < json.features.length; j++) {
        var state_data = json.features[j].properties.name;

        if (dataState == jsonState) {

          // Copy the data value into the JSON
          json.features[j].properties.value = dataValue;

          // Stop looking through the JSON
          break;
        }
      }

            incomeExtent = d3.extent(state_income, d=>d['income']);

            let colorScale = d3.scaleQuantile()
              .domain(incomeExtent)
              .range(colorArray);

            console.log(states.features);

            svg.selectAll("path.states")
              .data(states.features)
              .join("path")
              .attr("class", "states")
              .attr("d", path)
              .style("fill","red");

            svg.append("path")
              .datum(statesMesh)
              .attr("class","outline")
              .attr("d", path)
              .style("stroke-width",1)
              .style("stroke","white")
              .style("fill","none");

            svg.append("path")
              .datum(usMesh)
              .attr("class","outline")
              .attr("d", path)
              .style("stroke-width",3)
              .style("stroke","darkgrey")
              .style("fill","none");

          });

        });



/**

        let state_data = await d3.json("us_states.json");

let state_income = getAverageByState();

        console.log("hey");
        console.log(state_data);
        console.log(state_income);

        let svg = d3.select("svg#jkm253");
        let svgWidth = svg.attr("width");
        let svgHeight = svg.attr("height");

        let states = topojson.feature(state_data, state_data.objects.states);
        let statesMesh = topojson.mesh(state_data, state_data.objects.states);
        let usMesh = topojson.mesh(state_data, state_data.objects.nation);

        let projection = d3.geoMercator().fitSize([svgWidth, svgHeight], states);
        var path = d3.geoPath().projection(projection);

        let colorArray = ["#0d06aa","#0055d5","#1eabd0","#00d4a1","#6aff45"];

        incomeExtent = d3.extent(state_income, d=>d['income']);

        let colorScale = d3.scaleQuantile()
          .domain(incomeExtent)
          .range(colorArray);

        console.log(states.features);

        svg.selectAll("path.states")
          .data(state_income)
          .join("path")
          .attr("class", "states")
          .attr("d", path)
          .style("fill",d=>colorScale(d.income));

        svg.append("path")
          .datum(statesMesh)
          .attr("class","outline")
          .attr("d", path)
          .style("stroke-width",1)
          .style("stroke","white")
          .style("fill","none");

        svg.append("path")
          .datum(usMesh)
          .attr("class","outline")
          .attr("d", path)
          .style("stroke-width",3)
          .style("stroke","darkgrey")
          .style("fill","none");

      };**/
    }

      getData();



    </script>
</body>

</html>
